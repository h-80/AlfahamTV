<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One Sport</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #fff;
            margin: 0;
            padding: 0;
            color: #000;
            direction: rtl;
            overflow-x: hidden;
        }
        .header {
            background: #fff;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin: 0;
            font-size: 1.8em;
            color: #4CAF50;
        }
        .container {
            max-width: 1200px;
            margin: 10px auto;
            padding: 10px;
        }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            padding: 10px;
        }
        .category {
            background: #fff;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid #ccc;
        }
        .category:hover {
            transform: scale(1.05);
        }
        .category img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        .category span {
            display: block;
            padding: 8px;
            text-align: center;
            font-size: 1em;
            color: #000;
        }
        .channels-section {
            display: none;
            padding: 10px;
        }
        .channels-section.active {
            display: block;
        }
        .back-btn {
            background: #fff;
            color: #000;
            padding: 8px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .back-btn:hover {
            background: #e0e0e0;
        }
        .search-box {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #fff;
            color: #000;
            font-size: 1em;
        }
        .channels-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .channel {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .channel img {
            width: 50px;
            height: 50px;
            margin-left: 10px;
            border-radius: 5px;
        }
        .channel span {
            flex-grow: 1;
            font-size: 1.1em;
        }
        .watch-btn {
            background: #007bff;
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .watch-btn:hover {
            background: #0056b3;
        }
        .player-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 1000;
            overflow: hidden;
            box-sizing: border-box;
        }
        #player {
            width: 100% !important;
            height: 100% !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            object-fit: fill !important;
            object-position: center;
            display: block !important;
            z-index: 1001;
            position: relative;
            background: #000;
            margin: 0 auto !important;
        }
        .plyr__controls {
            z-index: 1002 !important;
            width: 100% !important;
            max-width: 100vw !important;
            margin: 0 auto;
            padding: 5px;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .server-selection {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            flex-wrap: nowrap;
            gap: 5px;
            background: #fff;
            padding: 5px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: nowrap;
            max-width: 90vw;
            z-index: 1003;
            border: 1px solid #ccc;
            box-sizing: border-box;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
        }
        .server-selection.visible {
            display: flex;
            opacity: 1;
            visibility: visible;
        }
        .server-btn {
            background: #ffffff;
            color: #000;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .server-btn.active {
            background: #00bcd4;
            color: #fff;
        }
        .server-btn:hover {
            background: #b0bec5;
        }
        .server-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .server-selection::-webkit-scrollbar {
            display: none;
        }
        .server-selection {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .player-back-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fff;
            color: #000;
            padding: 8px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1003;
            font-size: 1em;
            transition: background 0.2s;
        }
        .player-back-btn:hover {
            background: #e0e0e0;
        }
        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 5px solid #444;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            z-index: 1003;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .video-error {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff4444;
            background: #fff;
            padding: 10px;
            border: 1px solid #ff4444;
            border-radius: 5px;
            z-index: 1003;
            text-align: center;
            max-width: 90vw;
        }
        @media (orientation: landscape) {
            .player-container {
                width: 100vw;
                height: 100vh;
            }
            #player {
                width: 100% !important;
                height: 100% !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                object-fit: fill !important;
                object-position: center;
                margin: 0 auto !important;
            }
            .plyr__controls {
                width: 100% !important;
                max-width: 100vw !important;
                margin: 0 auto;
            }
            .server-selection {
                max-width: 90vw;
                transform: translateX(-50%);
            }
        }
        @media (orientation: portrait) {
            .player-container {
                width: 100vw;
                height: 100vh;
            }
            #player {
                width: 100% !important;
                height: 100% !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                object-fit: fill !important;
                object-position: center;
                margin: 0 auto !important;
            }
            .plyr__controls {
                width: 100% !important;
                max-width: 100vw !important;
                margin: 0 auto;
            }
            .server-selection {
                max-width: 90vw;
                transform: translateX(-50%);
            }
        }
        .player-container:-webkit-full-screen #player,
        .player-container:fullscreen #player {
            width: 100% !important;
            height: 100% !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            object-fit: fill !important;
            object-position: center;
            margin: 0 auto !important;
        }
        .player-container:-webkit-full-screen,
        .player-container:fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Amine pro</h1>
    </div>
    <div class="container">
        <div class="categories-grid" id="categoriesGrid"></div>
        <div class="channels-section" id="channelsSection">
            <button class="back-btn" onclick="showCategories()">رجوع</button>
            <h2 id="categoryTitle"></h2>
            <input type="text" class="search-box" id="searchBox" placeholder="ابحث عن قناة...">
            <div class="channels-list" id="channelsList"></div>
        </div>
    </div>
    <div class="player-container" id="playerContainer">
        <button class="player-back-btn" id="playerBackBtn">رجوع</button>
        <div class="server-selection" id="serverSelection"></div>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <p class="video-error" id="videoError"></p>
        <video id="player" controls playsinline preload="auto"></video>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dash.js@4.7.0/dist/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.5/dist/shaka-player.compiled.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
  apiKey: "AIzaSyARzpeY20p5R1RXGYX_83zQkyLHywp-SE4",
  authDomain: "one-sport-67e48.firebaseapp.com",
  databaseURL: "https://one-sport-67e48-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "one-sport-67e48",
  storageBucket: "one-sport-67e48.firebasestorage.app",
  messagingSenderId: "238395812570",
  appId: "1:238395812570:web:6361f8ecac34d1061fd3e3"
};

try {
  firebase.initializeApp(firebaseConfig);
  console.log('Firebase initialized successfully');
} catch (err) {
  console.error('Error initializing Firebase:', err);
}

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully');
        } catch (err) {
            console.error('Firebase initialization error:', err);
            const categoriesGrid = document.getElementById('categoriesGrid');
            if (categoriesGrid) {
                categoriesGrid.innerHTML = '<p style="color: #ff4444;">خطأ في الاتصال بـ Firebase. تحقق من إعدادات firebaseConfig.</p>';
            }
        }

        const db = firebase.database();
        const categoriesRef = db.ref('categories');
        let player, hls, dashPlayer, shakaPlayer, currentServer = 'url', currentChannelServers = {};
        const serverOrder = ['url', 'hd', 'sd', 'low', 'backup1', 'backup2'];
        let serverControlsTimeout, playerControlsTimeout, fallbackTimeout;

        // Load app
        window.addEventListener('load', () => {
            initializePlayer();
            loadCategories();
            const playerContainer = document.getElementById('playerContainer');
            const channelsSection = document.getElementById('channelsSection');
            if (playerContainer) playerContainer.style.display = 'none';
            if (channelsSection) channelsSection.style.display = 'none';
        });

        // Initialize player
        function initializePlayer() {
            try {
                const videoElement = document.getElementById('player');
                if (!videoElement) {
                    throw new Error('Video element not found');
                }

                if (typeof Plyr === 'undefined') {
                    throw new Error('Plyr library not loaded');
                }

                player = new Plyr(videoElement, {
                    controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
                    autoplay: true,
                    playsinline: true,
                    hideControls: true,
                    resetOnEnd: true,
                    clickToPlay: false
                });

                player.on('error', (event) => {
                    console.error('Player error:', event.detail);
                    showError('خطأ في تشغيل الفيديو. جارٍ المحاولة مع سيرفر آخر...');
                    tryNextServer();
                });

                player.on('ready', () => {
                    console.log('Player ready');
                    hideSpinner();
                    videoElement.style.display = 'block';
                    showServerControls();
                    showPlayerControls();
                    player.play().catch(err => console.error('Play error:', err));
                });

                player.on('canplay', () => {
                    console.log('Video can play');
                    clearTimeout(fallbackTimeout);
                    hideSpinner();
                    showServerControls();
                    showPlayerControls();
                });

                // Handle fullscreen events
                player.on('enterfullscreen', () => {
                    console.log('Entered fullscreen');
                    showServerControls();
                    showPlayerControls();
                });

                player.on('exitfullscreen', () => {
                    console.log('Exited fullscreen');
                    showServerControls();
                    showPlayerControls();
                });

                // Initialize back button
                const playerBackBtn = document.getElementById('playerBackBtn');
                if (playerBackBtn) {
                    playerBackBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        console.log('Back button clicked');
                        handlePlayerBack();
                    });
                }

                // Add click event on video to show controls
                videoElement.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const target = event.target;
                    if (target.id === 'player' && !target.closest('.plyr__controls') && !target.closest('.server-selection') && !target.closest('.player-back-btn')) {
                        console.log('Video clicked, showing controls');
                        showPlayerControls();
                        showServerControls();
                    }
                });

                // Add mouse move event to show controls
                videoElement.addEventListener('mousemove', () => {
                    showPlayerControls();
                    showServerControls();
                });

                console.log('Player initialized successfully');
            } catch (err) {
                console.error('Error initializing Plyr:', err);
                showError('خطأ في تهيئة المشغل. تحقق من اتصالك.');
            }
        }

        // Show Plyr controls
        function showPlayerControls() {
            const controls = document.querySelector('.plyr__controls');
            if (controls) {
                controls.style.opacity = '1';
                controls.style.visibility = 'visible';
                clearTimeout(playerControlsTimeout);
                playerControlsTimeout = setTimeout(hidePlayerControls, 3000);
                console.log('Plyr controls shown');
            }
        }

        // Hide Plyr controls
        function hidePlayerControls() {
            const controls = document.querySelector('.plyr__controls');
            if (controls) {
                controls.style.opacity = '0';
                controls.style.visibility = 'hidden';
                console.log('Plyr controls hidden');
            }
        }

        // Show server controls
        function showServerControls() {
            const serverSelection = document.getElementById('serverSelection');
            if (serverSelection) {
                serverSelection.classList.add('visible');
                clearTimeout(serverControlsTimeout);
                serverControlsTimeout = setTimeout(hideServerControls, 3000);
                console.log('Server controls shown');
            }
        }

        // Hide server controls
        function hideServerControls() {
            const serverSelection = document.getElementById('serverSelection');
            if (serverSelection) {
                serverSelection.classList.remove('visible');
                console.log('Server controls hidden');
            }
        }

        // Show/hide spinner and error
        function showSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            const error = document.getElementById('videoError');
            if (spinner) spinner.style.display = 'block';
            if (error) error.style.display = 'none';
        }

        function hideSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.style.display = 'none';
        }

        function showError(message) {
            const error = document.getElementById('videoError');
            if (error) {
                error.textContent = message;
                error.style.display = 'block';
                hideSpinner();
                hideServerControls();
            }
        }

        // Handle orientation change
        function handleOrientationChange() {
            const videoElement = document.getElementById('player');
            const controls = document.querySelector('.plyr__controls');
            const serverSelection = document.querySelector('.server-selection');
            const playerContainer = document.getElementById('playerContainer');

            if (videoElement && playerContainer && playerContainer.style.display === 'block') {
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.style.maxWidth = '100vw';
                videoElement.style.maxHeight = '100vh';
                videoElement.style.objectFit = 'fill';
                videoElement.style.objectPosition = 'center';
                videoElement.style.margin = '0 auto';
            }

            if (controls) {
                controls.style.width = '100%';
                controls.style.maxWidth = '100vw';
                controls.style.transform = 'none';
            }

            if (serverSelection) {
                serverSelection.style.maxWidth = '90vw';
                serverSelection.style.transform = 'translateX(-50%)';
            }

            console.log('Orientation changed, player components adjusted');
            showPlayerControls();
            showServerControls();
        }

        window.addEventListener('orientationchange', handleOrientationChange);
        window.addEventListener('resize', handleOrientationChange);

        // Load categories
        async function loadCategories() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            if (!categoriesGrid) {
                console.error('Categories grid element not found');
                return;
            }

            categoriesGrid.innerHTML = '<p>جارٍ التحميل...</p>';

            try {
                console.log('Attempting to fetch categories from Firebase');
                const snapshot = await categoriesRef.once('value');
                if (!snapshot.exists()) {
                    console.warn('No categories found in Firebase database');
                    categoriesGrid.innerHTML = '<p style="color: #ff4444;">لا توجد أقسام متاحة. تحقق من وجود بيانات في المسار categories.</p>';
                    return;
                }

                const categoriesData = snapshot.val();
                console.log('Categories data:', categoriesData);
                categoriesGrid.innerHTML = '';
                let hasValidCategories = false;
                Object.keys(categoriesData).forEach(key => {
                    const data = categoriesData[key];
                    if (data && data.name && data.image) {
                        console.log(`Processing category: ${data.name}`);
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'category';
                        categoryDiv.innerHTML = `
                            <img src="${data.image}" alt="${data.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/150';">
                            <span>${data.name}</span>
                        `;
                        categoryDiv.onclick = () => loadChannels(key, data.name);
                        categoriesGrid.appendChild(categoryDiv);
                        hasValidCategories = true;
                    } else {
                        console.warn(`Skipping invalid category data for key ${key}:`, data);
                    }
                });

                if (!hasValidCategories) {
                    categoriesGrid.innerHTML = '<p style="color: #ff4444;">لا توجد أقسام صالحة. تحقق من تنسيق البيانات (name وimage مطلوبان).</p>';
                } else {
                    console.log('Categories loaded successfully');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                categoriesGrid.innerHTML = `<p style="color: #ff4444;">خطأ في تحميل الأقسام: ${error.message}. تحقق من الاتصال أو قواعد Firebase.</p>`;
            }
        }

        // Load channels
        async function loadChannels(categoryId, categoryName) {
            const channelsSection = document.getElementById('channelsSection');
            const channelsList = document.getElementById('channelsList');
            const categoryTitle = document.getElementById('categoryTitle');
            const categoriesGrid = document.getElementById('categoriesGrid');
            const searchBox = document.getElementById('searchBox');

            if (!channelsSection || !channelsList || !categoryTitle || !categoriesGrid) {
                console.error('Required elements for channels not found');
                return;
            }

            categoryTitle.textContent = categoryName;
            channelsList.innerHTML = '<p>جارٍ التحميل...</p>';
            categoriesGrid.style.display = 'none';
            channelsSection.style.display = 'block';
            channelsSection.className = 'channels-section active';

            try {
                const snapshot = await db.ref('channels').once('value');
                channelsList.innerHTML = '';

                if (!snapshot.exists()) {
                    console.warn('No channels found in Firebase database');
                    channelsList.innerHTML = '<p style="color: #ff4444;">لا توجد قنوات متاحة.</p>';
                    return;
                }

                const channels = [];
                snapshot.forEach(child => {
                    const data = child.val();
                    if (data && data.category === categoryId) {
                        data.id = child.key;
                        channels.push(data);
                    }
                });

                displayChannels(channels);

                searchBox.value = '';
                searchBox.oninput = () => {
                    const searchText = searchBox.value.toLowerCase();
                    const filteredChannels = channels.filter(c => c.name && c.name.toLowerCase().includes(searchText));
                    displayChannels(filteredChannels);
                };
            } catch (error) {
                console.error('Error loading channels:', error);
                channelsList.innerHTML = `<p style="color: #ff4444;">خطأ في تحميل القنوات: ${error.message}</p>`;
            }
        }

        // Display channels
        function displayChannels(channels) {
            const channelsList = document.getElementById('channelsList');
            if (!channelsList) {
                console.error('Channels list element not found');
                return;
            }

            channelsList.innerHTML = '';

            if (channels.length === 0) {
                channelsList.innerHTML = '<p>لا توجد قنوات في هذا القسم.</p>';
                return;
            }

            channels.forEach(data => {
                if (!data.name || !data.logo) {
                    console.warn('Skipping invalid channel data:', data);
                    return;
                }
                const servers = {
                    url: data.url || '',
                    hd: data.hd_url || '',
                    sd: data.sd_url || '',
                    low: data.low_url || '',
                    backup1: data.backup1_url || '',
                    backup2: data.backup2_url || ''
                };
                console.log('Channel servers for', data.name, ':', servers);
                const channelDiv = document.createElement('div');
                channelDiv.className = 'channel';
                channelDiv.innerHTML = `
                    <img src="${data.logo}" alt="${data.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/50';">
                    <span>${data.name}</span>
                    <button class="watch-btn" data-servers='${JSON.stringify(servers).replace(/'/g, "\\'")}' onclick="handlePlayChannel(this)">مشاهدة</button>
                `;
                channelsList.appendChild(channelDiv);
            });
        }

        // Handle play channel
        function handlePlayChannel(button) {
            try {
                const servers = JSON.parse(button.getAttribute('data-servers').replace(/\\'/g, "'"));
                console.log('Parsed servers:', servers);
                playChannel(servers);
            } catch (err) {
                console.error('Error parsing servers:', err);
                showError('خطأ في تحميل بيانات القناة.');
            }
        }

        // Show categories
        function showCategories() {
            const channelsSection = document.getElementById('channelsSection');
            const categoriesGrid = document.getElementById('categoriesGrid');
            if (channelsSection) channelsSection.style.display = 'none';
            if (categoriesGrid) categoriesGrid.style.display = 'grid';
            if (channelsSection) channelsSection.className = 'channels-section';
        }

        // Play channel
        async function playChannel(servers) {
            currentChannelServers = servers;
            console.log('Playing channel with servers:', currentChannelServers);
            currentServer = 'url';
            const playerContainer = document.getElementById('playerContainer');
            if (playerContainer) {
                playerContainer.style.display = 'block';
            }
            showSpinner();
            showServerControls();
            showPlayerControls();
            createServerButtons();

            try {
                if (playerContainer && playerContainer.requestFullscreen) {
                    await playerContainer.requestFullscreen();
                    if (screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape').catch(err => {
                            console.warn('Orientation lock failed:', err);
                        });
                    }
                } else if (playerContainer && playerContainer.webkitRequestFullscreen) {
                    await playerContainer.webkitRequestFullscreen();
                }
                console.log('Fullscreen requested');
            } catch (err) {
                console.error('Fullscreen error:', err);
            }

            await switchServer(currentServer);
            fallbackTimeout = setTimeout(tryNextServer, 10000);
            handleOrientationChange();
        }

        // Create server buttons
        function createServerButtons() {
            const serverSelection = document.getElementById('serverSelection');
            if (!serverSelection) {
                console.error('Server selection element not found');
                return;
            }

            serverSelection.innerHTML = '';
            console.log('Creating server buttons for:', currentChannelServers);

            const servers = [
                { key: 'url', label: 'الأساسي' },
                { key: 'hd', label: 'HD' },
                { key: 'sd', label: 'SD' },
                { key: 'low', label: 'Low' },
                { key: 'backup1', label: 'الاحتياطي 1' },
                { key: 'backup2', label: 'الاحتياطي 2' }
            ];

            let hasServers = false;
            servers.forEach(server => {
                const serverUrl = currentChannelServers[server.key];
                console.log(`Processing server: ${server.label} (URL: ${serverUrl})`);
                const button = document.createElement('button');
                button.className = 'server-btn';
                button.textContent = server.label;
                button.onclick = (event) => {
                    event.stopPropagation();
                    console.log(`Server button clicked: ${server.key}`);
                    switchServer(server.key);
                    showServerControls();
                    showPlayerControls();
                };
                if (server.key === currentServer) {
                    button.classList.add('active');
                }
                if (!serverUrl || !isValidUrl(serverUrl)) {
                    button.disabled = true;
                    console.warn(`Server ${server.label} disabled due to invalid URL: ${serverUrl}`);
                } else {
                    hasServers = true;
                }
                serverSelection.appendChild(button);
            });

            if (!hasServers) {
                serverSelection.innerHTML = '<p style="color: #000;">لا توجد سيرفرات متاحة</p>';
                console.warn('No valid servers found for this channel');
            }
            showServerControls();
        }

        // Try next server
        async function tryNextServer() {
            const currentIndex = serverOrder.indexOf(currentServer);
            const nextIndex = currentIndex + 1;

            if (nextIndex < serverOrder.length) {
                const nextServer = serverOrder[nextIndex];
                if (currentChannelServers[nextServer] && isValidUrl(currentChannelServers[nextServer])) {
                    console.log(`Switching to next server: ${nextServer}`);
                    await switchServer(nextServer);
                    fallbackTimeout = setTimeout(tryNextServer, 10000);
                } else {
                    tryNextServer();
                }
            } else {
                showError('جميع السيرفرات غير متاحة. تحقق من اتصالك أو حاول لاحقًا.');
                hideServerControls();
                hidePlayerControls();
            }
        }

        // Switch server
        async function switchServer(serverKey) {
            clearTimeout(fallbackTimeout);
            currentServer = serverKey;
            const url = currentChannelServers[serverKey];
            if (!url || !isValidUrl(url)) {
                console.warn('Invalid server URL:', url);
                showError('رابط السيرفر غير صالح.');
                tryNextServer();
                return;
            }

            const buttons = document.querySelectorAll('.server-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (getServerLabel(serverKey) === btn.textContent) {
                    btn.classList.add('active');
                }
            });

            await cleanupPlayer();
            showSpinner();

            const videoElement = document.getElementById('player');
            if (!videoElement) {
                console.warn('Video element not found during server switch');
                return;
            }
            videoElement.style.display = 'block';

            try {
                if (url.includes('.m3u8') && Hls.isSupported()) {
                    if (hls) {
                        hls.destroy();
                        hls = null;
                    }
                    hls = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        maxBufferLength: 30,
                        liveSyncDurationCount: 3,
                        liveMaxLatencyDurationCount: 10
                    });
                    hls.loadSource(url);
                    hls.attachMedia(videoElement);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        console.log('HLS manifest parsed');
                        hideSpinner();
                        player.play().catch(err => console.error('Play error:', err));
                    });
                    hls.on(Hls.Events.ERROR, (event, data) => {
                        console.error('HLS error:', data);
                        showError(`خطأ في تحميل الفيديو: ${data.type}`);
                        tryNextServer();
                    });
                } else if (url.includes('.mpd') && dashjs.MediaPlayer().create().isSupported()) {
                    if (dashPlayer) dashPlayer.reset();
                    dashPlayer = dashjs.MediaPlayer().create();
                    dashPlayer.initialize(videoElement, url, true);
                    dashPlayer.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
                        hideSpinner();
                        player.play().catch(err => console.error('Play error:', err));
                    });
                    dashPlayer.on(dashjs.MediaPlayer.events.ERROR, (event) => {
                        console.error('DASH error:', event);
                        showError('خطأ في تحميل الفيديو DASH.');
                        tryNextServer();
                    });
                } else if (url.includes('.m3u8') && shaka.Player.isBrowserSupported()) {
                    if (shakaPlayer) await shakaPlayer.destroy();
                    shakaPlayer = new shaka.Player(videoElement);
                    await shakaPlayer.load(url);
                    hideSpinner();
                    player.play().catch(err => console.error('Play error:', err));
                    shakaPlayer.addEventListener('error', (event) => {
                        console.error('Shaka error:', event);
                        showError('خطأ في تحميل الفيديو Shaka.');
                        tryNextServer();
                    });
                } else {
                    videoElement.src = url;
                    player.source = {
                        type: 'video',
                        sources: [{ src: url, type: guessMimeType(url) }]
                    };
                    videoElement.load();
                    videoElement.addEventListener('canplay', () => {
                        console.log('Video canplay event');
                        hideSpinner();
                        player.play().catch(err => console.error('Play error:', err));
                    }, { once: true });
                    videoElement.addEventListener('error', () => {
                        console.error('Video element error');
                        showError('خطأ في تحميل الفيديو.');
                        tryNextServer();
                    }, { once: true });
                }
            } catch (err) {
                console.error('Error switching server:', err);
                showError('خطأ في تحميل الفيديو.');
                tryNextServer();
            }
        }

        // Cleanup player
        async function cleanupPlayer() {
            try {
                if (player) {
                    player.stop();
                    player.source = null;
                }
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                if (dashPlayer) {
                    dashPlayer.reset();
                    dashPlayer = null;
                }
                if (shakaPlayer) {
                    await shakaPlayer.destroy();
                    shakaPlayer = null;
                }
                const videoElement = document.getElementById('player');
                if (videoElement) {
                    videoElement.src = '';
                    videoElement.load();
                    videoElement.style.display = 'block';
                }
                hideServerControls();
                hidePlayerControls();
            } catch (err) {
                console.error('Error cleaning up player:', err);
            }
        }

        // Handle player back
        function handlePlayerBack() {
            console.log('Handling player back');
            const playerContainer = document.getElementById('playerContainer');
            const channelsSection = document.getElementById('channelsSection');
            const categoriesGrid = document.getElementById('categoriesGrid');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const videoError = document.getElementById('videoError');

            cleanupPlayer().then(() => {
                if (playerContainer) {
                    playerContainer.style.display = 'none';
                }
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (videoError) videoError.style.display = 'none';
                if (categoriesGrid) categoriesGrid.style.display = 'grid';
                if (channelsSection) {
                    channelsSection.style.display = 'none';
                    channelsSection.className = 'channels-section';
                }
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(err => console.warn('Exit fullscreen failed:', err));
                }
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock().catch(err => console.warn('Orientation unlock failed:', err));
                }
                hideServerControls();
                hidePlayerControls();
                console.log('Player closed, categories shown');
            }).catch(err => {
                console.error('Error during handlePlayerBack:', err);
                showError('خطأ أثناء إغلاق المشغل.');
            });
        }

        // Handle browser back
        window.addEventListener('popstate', () => {
            const playerContainer = document.getElementById('playerContainer');
            const channelsSection = document.getElementById('channelsSection');
            if (playerContainer && playerContainer.style.display === 'block') {
                handlePlayerBack();
            } else if (channelsSection && channelsSection.style.display === 'block') {
                showCategories();
            }
        });

        // Handle fullscreen change
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                console.log('Fullscreen entered via browser');
                showServerControls();
                showPlayerControls();
            } else {
                console.log('Fullscreen exited via browser');
                showServerControls();
                showPlayerControls();
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock().catch(err => console.warn('Orientation unlock failed:', err));
                }
            }
        });

        // Validate URL
        function isValidUrl(url) {
            if (!url || typeof url !== 'string') return false;
            try {
                new URL(url);
                return url.startsWith('http://') || url.startsWith('https://');
            } catch {
                return false;
            }
        }

        // Get server label
        function getServerLabel(key) {
            const labels = {
                url: 'الأساسي',
                hd: 'HD',
                sd: 'SD',
                low: 'Low',
                backup1: 'الاحتياطي 1',
                backup2: 'الاحتياطي 2'
            };
            return labels[key] || key;
        }

        // Guess MIME type
        function guessMimeType(url) {
            if (url.includes('.mp4')) return 'video/mp4';
            if (url.includes('.m3u8')) return 'application/x-mpegURL';
            if (url.includes('.mpd')) return 'application/dash+xml';
            return 'video/mp4';
        }
    </script>
</body>
</html>